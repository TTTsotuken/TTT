<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¿»è¨³ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK v9 (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <div id="root"></div>

    <script>
        // ğŸ”¥ ã“ã“ã«Firebaseã®è¨­å®šã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
const firebaseConfig = {
  apiKey: "AIzaSyDLsRsitmY4uPX6a_-RTtq1X1EfQW4L7Uw",
  authDomain: "translation-chat-561ae.firebaseapp.com",
  databaseURL: "https://translation-chat-561ae-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "translation-chat-561ae",
  storageBucket: "translation-chat-561ae.firebasestorage.app",
  messagingSenderId: "731320381667",
  appId: "1:731320381667:web:9b256ebf09de1e935455d6"
};

        // Firebaseã‚’åˆæœŸåŒ–
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Lucide icons
        const Send = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        );

        const Mic = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
            </svg>
        );

        const MicOff = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="1" y1="1" x2="23" y2="23"></line>
                <path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"></path>
                <path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
            </svg>
        );

        const Globe = () => (
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="2" y1="12" x2="22" y2="12"></line>
                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
            </svg>
        );

        const Users = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
        );

        const Lock = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
        );

        const LogOut = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
        );

        const Trash2 = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );

        const CheckCircle = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
        );

        const TranslationChatApp = () => {
            const [screen, setScreen] = useState('login');
            const [roomId, setRoomId] = useState('');
            const [password, setPassword] = useState('');
            const [userName, setUserName] = useState('');
            const [userLanguage, setUserLanguage] = useState('ja');
            const [currentRoom, setCurrentRoom] = useState(null);
            const [message, setMessage] = useState('');
            const [messages, setMessages] = useState([]);
            const [isRecording, setIsRecording] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            const [roomUsers, setRoomUsers] = useState([]);
            const [isConnected, setIsConnected] = useState(true);
            const messagesEndRef = useRef(null);
            const recognitionRef = useRef(null);
            const messagesListenerRef = useRef(null);
            const usersListenerRef = useRef(null);

            const languages = [
                { code: 'ja', name: 'æ—¥æœ¬èª' },
                { code: 'en', name: 'English' },
                { code: 'zh-CN', name: 'ä¸­æ–‡' },
                { code: 'ko', name: 'í•œêµ­ì–´' },
                { code: 'es', name: 'EspaÃ±ol' },
                { code: 'fr', name: 'FranÃ§ais' },
                { code: 'de', name: 'Deutsch' },
                { code: 'it', name: 'Italiano' },
                { code: 'pt', name: 'PortuguÃªs' },
                { code: 'ru', name: 'Ğ ÑƒÑÑĞºĞ¸Ğ¹' },
                { code: 'ar', name: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' },
                { code: 'hi', name: 'à¤¹à¤¿à¤¨à¥à¤¦à¥€' },
                { code: 'th', name: 'à¹„à¸—à¸¢' },
                { code: 'vi', name: 'Tiáº¿ng Viá»‡t' }
            ];

            // Firebaseæ¥ç¶šçŠ¶æ…‹ã®ç›£è¦–
            useEffect(() => {
                const connectedRef = database.ref('.info/connected');
                connectedRef.on('value', (snap) => {
                    setIsConnected(snap.val() === true);
                });
                return () => connectedRef.off();
            }, []);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            useEffect(() => {
                return () => {
                    if (messagesListenerRef.current && currentRoom) {
                        database.ref(`rooms/${currentRoom.id}/messages`).off('value', messagesListenerRef.current);
                    }
                    if (usersListenerRef.current && currentRoom) {
                        database.ref(`rooms/${currentRoom.id}/users`).off('value', usersListenerRef.current);
                    }
                };
            }, [currentRoom]);

            const showError = (msg) => {
                setError(msg);
                setTimeout(() => setError(''), 5000);
            };

            const showSuccess = (msg) => {
                setSuccess(msg);
                setTimeout(() => setSuccess(''), 3000);
            };

            const translateText = async (text, targetLang) => {
                try {
                    const response = await fetch(
                        `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`
                    );
                    const data = await response.json();
                    return data[0][0][0];
                } catch (error) {
                    console.error('Translation error:', error);
                    return text;
                }
            };

            const handleLogin = async () => {
                if (!roomId || !password || !userName || !userLanguage) {
                    showError('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                if (!isConnected) {
                    showError('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„');
                    return;
                }

                try {
                    // ãƒ«ãƒ¼ãƒ æƒ…å ±ã‚’å–å¾—
                    const roomRef = database.ref(`rooms/${roomId}`);
                    const roomSnapshot = await roomRef.once('value');
                    const roomData = roomSnapshot.val();

                    if (roomData) {
                        // æ—¢å­˜ã®ãƒ«ãƒ¼ãƒ 
                        if (roomData.password !== password) {
                            showError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                            return;
                        }

                        const users = roomData.users || {};
                        const usersList = Object.values(users);

                        // åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒã™ã§ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        const existingUserEntry = Object.entries(users).find(([_, u]) => u.name === userName);
                        
                        if (!existingUserEntry) {
                            // 2äººä»¥ä¸Šã®ãƒã‚§ãƒƒã‚¯
                            if (usersList.length >= 2) {
                                showError('ã“ã®ãƒ«ãƒ¼ãƒ ã¯æ—¢ã«æº€å“¡ã§ã™ï¼ˆæœ€å¤§2äººï¼‰');
                                return;
                            }
                            
                            // æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ 
                            const userId = `user_${Date.now()}`;
                            await database.ref(`rooms/${roomId}/users/${userId}`).set({
                                name: userName,
                                language: userLanguage,
                                joinedAt: firebase.database.ServerValue.TIMESTAMP
                            });
                            showSuccess('ãƒ«ãƒ¼ãƒ ã«å‚åŠ ã—ã¾ã—ãŸï¼');
                        } else {
                            showSuccess('ãƒ«ãƒ¼ãƒ ã«å†æ¥ç¶šã—ã¾ã—ãŸï¼');
                        }
                    } else {
                        // æ–°ã—ã„ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ
                        const userId = `user_${Date.now()}`;
                        await roomRef.set({
                            password: password,
                            createdAt: firebase.database.ServerValue.TIMESTAMP,
                            users: {
                                [userId]: {
                                    name: userName,
                                    language: userLanguage,
                                    joinedAt: firebase.database.ServerValue.TIMESTAMP
                                }
                            }
                        });
                        showSuccess('æ–°ã—ã„ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã—ãŸï¼');
                    }

                    setCurrentRoom({ id: roomId, password: password });
                    setScreen('chat');

                    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                    const messagesRef = database.ref(`rooms/${roomId}/messages`);
                    messagesListenerRef.current = messagesRef.on('value', (snapshot) => {
                        const messagesData = snapshot.val();
                        if (messagesData) {
                            const messagesList = Object.values(messagesData).sort((a, b) => 
                                a.timestamp - b.timestamp
                            );
                            setMessages(messagesList);
                        } else {
                            setMessages([]);
                        }
                    });

                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                    const usersRef = database.ref(`rooms/${roomId}/users`);
                    usersListenerRef.current = usersRef.on('value', (snapshot) => {
                        const usersData = snapshot.val();
                        if (usersData) {
                            const usersList = Object.values(usersData);
                            setRoomUsers(usersList);
                        } else {
                            setRoomUsers([]);
                        }
                    });

                } catch (error) {
                    console.error('Login error:', error);
                    showError('ãƒ«ãƒ¼ãƒ ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            };

            const handleSendMessage = async () => {
                if (!message.trim() || !currentRoom) return;

                if (!isConnected) {
                    showError('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„');
                    return;
                }

                const otherUser = roomUsers.find(u => u.name !== userName);
                if (!otherUser) {
                    showError('ç›¸æ‰‹ãŒã¾ã å‚åŠ ã—ã¦ã„ã¾ã›ã‚“');
                    return;
                }

                try {
                    const translatedText = await translateText(message, otherUser.language);
                    
                    const messageId = database.ref(`rooms/${currentRoom.id}/messages`).push().key;
                    const newMessage = {
                        id: messageId,
                        sender: userName,
                        senderLang: userLanguage,
                        originalText: message,
                        translatedText: translatedText,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };

                    await database.ref(`rooms/${currentRoom.id}/messages/${messageId}`).set(newMessage);
                    setMessage('');
                    setError('');
                } catch (error) {
                    console.error('Send message error:', error);
                    showError('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            };

            const startRecording = () => {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    showError('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ï¼ˆChromeæ¨å¥¨ï¼‰');
                    return;
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognitionRef.current = new SpeechRecognition();
                
                // è¨€èªã‚³ãƒ¼ãƒ‰ã®èª¿æ•´ï¼ˆéŸ³å£°èªè­˜ç”¨ï¼‰
                let recognitionLang = userLanguage;
                if (userLanguage === 'zh-CN') recognitionLang = 'zh-CN';
                
                recognitionRef.current.lang = recognitionLang;
                recognitionRef.current.continuous = false;
                recognitionRef.current.interimResults = false;

                recognitionRef.current.onstart = () => {
                    setIsRecording(true);
                    setError('');
                };

                recognitionRef.current.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    setMessage(transcript);
                };

                recognitionRef.current.onerror = (event) => {
                    showError('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ' + event.error);
                    setIsRecording(false);
                };

                recognitionRef.current.onend = () => {
                    setIsRecording(false);
                };

                try {
                    recognitionRef.current.start();
                } catch (error) {
                    showError('éŸ³å£°èªè­˜ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    setIsRecording(false);
                }
            };

            const stopRecording = () => {
                if (recognitionRef.current) {
                    recognitionRef.current.stop();
                    setIsRecording(false);
                }
            };

            const handleLogout = async () => {
                if (messagesListenerRef.current && currentRoom) {
                    database.ref(`rooms/${currentRoom.id}/messages`).off('value', messagesListenerRef.current);
                }
                if (usersListenerRef.current && currentRoom) {
                    database.ref(`rooms/${currentRoom.id}/users`).off('value', usersListenerRef.current);
                }
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ«ãƒ¼ãƒ ã‹ã‚‰å‰Šé™¤
                if (currentRoom) {
                    const usersRef = database.ref(`rooms/${currentRoom.id}/users`);
                    const snapshot = await usersRef.once('value');
                    const users = snapshot.val() || {};
                    
                    Object.entries(users).forEach(([userId, user]) => {
                        if (user.name === userName) {
                            database.ref(`rooms/${currentRoom.id}/users/${userId}`).remove();
                        }
                    });
                }
                
                setScreen('login');
                setCurrentRoom(null);
                setMessages([]);
                setRoomUsers([]);
                setRoomId('');
                setPassword('');
                setError('');
            };

            const clearRoom = async () => {
                if (!window.confirm('ã“ã®ãƒ«ãƒ¼ãƒ ã®å…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰')) return;
                
                try {
                    await database.ref(`rooms/${currentRoom.id}/messages`).remove();
                    showSuccess('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                } catch (error) {
                    showError('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            };

            if (screen === 'login') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
                            <div className="flex items-center justify-center mb-6">
                                <div className="text-indigo-600 mr-3"><Globe /></div>
                                <h1 className="text-3xl font-bold text-gray-800">ç¿»è¨³ãƒãƒ£ãƒƒãƒˆ</h1>
                            </div>
                            
                            {!isConnected && (
                                <div className="mb-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                                    âš ï¸ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ - ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„
                                </div>
                            )}
                            
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        ãƒ«ãƒ¼ãƒ ID
                                    </label>
                                    <input
                                        type="text"
                                        value={roomId}
                                        onChange={(e) => setRoomId(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                        placeholder="ä¾‹: room123"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
                                    </label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                        placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        ãƒ¦ãƒ¼ã‚¶ãƒ¼å
                                    </label>
                                    <input
                                        type="text"
                                        value={userName}
                                        onChange={(e) => setUserName(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                        placeholder="ä¾‹: å¤ªéƒ"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        ã‚ãªãŸã®è¨€èª
                                    </label>
                                    <select
                                        value={userLanguage}
                                        onChange={(e) => setUserLanguage(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    >
                                        {languages.map(lang => (
                                            <option key={lang.code} value={lang.code}>{lang.name}</option>
                                        ))}
                                    </select>
                                </div>

                                {error && (
                                    <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                                        {error}
                                    </div>
                                )}

                                {success && (
                                    <div className="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg text-sm flex items-center">
                                        <CheckCircle />
                                        <span className="ml-2">{success}</span>
                                    </div>
                                )}

                                <button
                                    onClick={handleLogin}
                                    disabled={!isConnected}
                                    className="w-full bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700 transition-colors flex items-center justify-center disabled:bg-gray-400 disabled:cursor-not-allowed"
                                >
                                    <span className="mr-2"><Lock /></span>
                                    ãƒ«ãƒ¼ãƒ ã«å…¥ã‚‹
                                </button>

                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-800">
                                    <p className="font-medium mb-2">ğŸ’¡ ä½¿ã„æ–¹</p>
                                    <ul className="list-disc list-inside space-y-1 text-xs">
                                        <li>åŒã˜ãƒ«ãƒ¼ãƒ IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§2äººãŒå…¥å®¤ã§ãã¾ã™</li>
                                        <li>ç•°ãªã‚‹ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½</li>
                                        <li>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è‡ªå‹•ã§ç›¸æ‰‹ã®è¨€èªã«ç¿»è¨³ã•ã‚Œã¾ã™</li>
                                        <li>éŸ³å£°å…¥åŠ›ã«ã‚‚å¯¾å¿œï¼ˆChromeæ¨å¥¨ï¼‰</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex flex-col h-screen bg-gray-100">
                    <div className="bg-indigo-600 text-white p-4 shadow-lg">
                        <div className="max-w-4xl mx-auto flex items-center justify-between">
                            <div className="flex items-center">
                                <span className="mr-3"><Users /></span>
                                <div>
                                    <h2 className="font-bold text-lg">ãƒ«ãƒ¼ãƒ : {currentRoom?.id}</h2>
                                    <p className="text-sm text-indigo-200">
                                        {userName} ({languages.find(l => l.code === userLanguage)?.name})
                                        {roomUsers.length > 1 && ` â€¢ ${roomUsers.length}äººå‚åŠ ä¸­`}
                                    </p>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                {!isConnected && (
                                    <span className="text-xs bg-red-500 px-2 py-1 rounded">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span>
                                )}
                                <button
                                    onClick={clearRoom}
                                    className="p-2 hover:bg-indigo-700 rounded-lg transition-colors"
                                    title="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¨å‰Šé™¤"
                                >
                                    <Trash2 />
                                </button>
                                <button
                                    onClick={handleLogout}
                                    className="p-2 hover:bg-indigo-700 rounded-lg transition-colors"
                                    title="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ"
                                >
                                    <LogOut />
                                </button>
                            </div>
                        </div>
                    </div>

                    {roomUsers.length < 2 && (
                        <div className="bg-yellow-50 border-b border-yellow-200 p-3 text-center text-yellow-800 text-sm">
                            ç›¸æ‰‹ã®å‚åŠ ã‚’å¾…ã£ã¦ã„ã¾ã™... ({roomUsers.length}/2äºº)
                        </div>
                    )}

                    {error && (
                        <div className="bg-red-50 border-b border-red-200 p-3 text-center text-red-700 text-sm">
                            {error}
                        </div>
                    )}

                    {success && (
                        <div className="bg-green-50 border-b border-green-200 p-3 text-center text-green-700 text-sm flex items-center justify-center">
                            <CheckCircle />
                            <span className="ml-2">{success}</span>
                        </div>
                    )}

                    <div className="flex-1 overflow-y-auto p-4 max-w-4xl w-full mx-auto">
                        <div className="space-y-4">
                            {messages.length === 0 && (
                                <div className="text-center text-gray-500 py-12">
                                    <div className="text-6xl mb-4">ğŸ’¬</div>
                                    <p className="text-lg font-medium">ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“</p>
                                    <p className="text-sm mt-2">æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>
                                </div>
                            )}
                            {messages.map((msg) => {
                                const isOwnMessage = msg.sender === userName;
                                return (
                                    <div
                                        key={msg.id}
                                        className={`flex ${isOwnMessage ? 'justify-end' : 'justify-start'}`}
                                    >
                                        <div
                                            className={`max-w-xs lg:max-w-md xl:max-w-lg rounded-2xl p-4 ${
                                                isOwnMessage
                                                    ? 'bg-indigo-600 text-white'
                                                    : 'bg-white text-gray-800 shadow-md'
                                            }`}
                                        >
                                            <div className="font-medium text-sm mb-1">
                                                {msg.sender}
                                            </div>
                                            <div className="break-words whitespace-pre-wrap">
                                                {isOwnMessage ? msg.originalText : msg.translatedText}
                                            </div>
                                            {!isOwnMessage && msg.originalText !== msg.translatedText && (
                                                <div className={`text-xs mt-2 pt-2 border-t ${isOwnMessage ? 'border-indigo-400' : 'border-gray-200'} ${isOwnMessage ? 'text-indigo-200' : 'text-gray-500'}`}>
                                                    åŸæ–‡: {msg.originalText}
                                                </div>
                                            )}
                                            <div className={`text-xs mt-2 ${isOwnMessage ? 'text-indigo-200' : 'text-gray-400'}`}>
                                                {msg.timestamp && new Date(msg.timestamp).toLocaleString('ja-JP', {
                                                    month: 'short',
                                                    day: 'numeric',
                                                    hour: '2-digit',
                                                    minute: '2-digit'
                                                })}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                            <div ref={messagesEndRef} />
                        </div>
                    </div>

                    <div className="bg-white border-t border-gray-200 p-4">
                        <div className="max-w-4xl mx-auto">
                            {roomUsers.length < 2 && (
                                <div className="mb-2 text-center text-sm text-yellow-700 bg-yellow-50 py-2 px-4 rounded-lg">
                                    âš ï¸ ç›¸æ‰‹ãŒå‚åŠ ã™ã‚‹ã¾ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯é€ä¿¡ã§ãã¾ã›ã‚“
                                </div>
                            )}
                            <div className="flex gap-2">
                                <button
                                    onClick={isRecording ? stopRecording : startRecording}
                                    disabled={roomUsers.length < 2 || !isConnected}
                                    className={`p-3 rounded-lg transition-colors ${
                                        isRecording
                                            ? 'bg-red-600 text-white hover:bg-red-700'
                                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                    } disabled:bg-gray-100 disabled:text-gray-400 disabled:cursor-not-allowed`}
                                    title={isRecording ? 'éŒ²éŸ³åœæ­¢' : 'éŸ³å£°å…¥åŠ›'}
                                >
                                    {isRecording ? <MicOff /> : <Mic />}
                                </button>
                                
                                <input
                                    type="text"
                                    value={message}
                                    onChange={(e) => setMessage(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && !e.shiftKey && handleSendMessage()}
                                    disabled={roomUsers.length < 2 || !isConnected}
                                    placeholder={roomUsers.length < 2 ? "ç›¸æ‰‹ã®å‚åŠ ã‚’å¾…ã£ã¦ã„ã¾ã™..." : "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."}
                                    className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed"
                                />
                                
                                <button
                                    onClick={handleSendMessage}
                                    disabled={!message.trim() || roomUsers.length < 2 || !isConnected}
                                    className="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                                    title="é€ä¿¡"
                                >
                                    <Send />
                                </button>
                            </div>
                            <p className="text-xs text-gray-500 mt-2 text-center">
                                Enterã‚­ãƒ¼ã§é€ä¿¡ â€¢ {isConnected ? 'æ¥ç¶šä¸­' : 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³'}
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<TranslationChatApp />, document.getElementById('root'));
    </script>
</body>
</html>
