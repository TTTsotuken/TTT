<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>翻訳チャットアプリ</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Lucide icons as React components
        const Send = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        );

        const Mic = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
            </svg>
        );

        const MicOff = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="1" y1="1" x2="23" y2="23"></line>
                <path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"></path>
                <path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
            </svg>
        );

        const Globe = () => (
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="2" y1="12" x2="22" y2="12"></line>
                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
            </svg>
        );

        const Users = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
        );

        const Lock = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
        );

        const LogOut = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
        );

        const Trash2 = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );

        // Simple in-memory storage mock for development
        const mockStorage = {
            data: {},
            async get(key) {
                const value = this.data[key];
                return value ? { key, value, shared: true } : null;
            },
            async set(key, value) {
                this.data[key] = value;
                return { key, value, shared: true };
            },
            async delete(key) {
                delete this.data[key];
                return { key, deleted: true, shared: true };
            },
            async list(prefix) {
                const keys = Object.keys(this.data).filter(k => !prefix || k.startsWith(prefix));
                return { keys, prefix, shared: true };
            }
        };

        // Use window.storage if available, otherwise use mock
        window.storage = window.storage || mockStorage;

        const TranslationChatApp = () => {
            const [screen, setScreen] = useState('login');
            const [roomId, setRoomId] = useState('');
            const [password, setPassword] = useState('');
            const [userName, setUserName] = useState('');
            const [userLanguage, setUserLanguage] = useState('ja');
            const [currentRoom, setCurrentRoom] = useState(null);
            const [message, setMessage] = useState('');
            const [messages, setMessages] = useState([]);
            const [isRecording, setIsRecording] = useState(false);
            const [error, setError] = useState('');
            const messagesEndRef = useRef(null);
            const recognitionRef = useRef(null);
            const pollIntervalRef = useRef(null);

            const languages = [
                { code: 'ja', name: '日本語' },
                { code: 'en', name: 'English' },
                { code: 'zh', name: '中文' },
                { code: 'ko', name: '한국어' },
                { code: 'es', name: 'Español' },
                { code: 'fr', name: 'Français' },
                { code: 'de', name: 'Deutsch' },
                { code: 'it', name: 'Italiano' },
                { code: 'pt', name: 'Português' },
                { code: 'ru', name: 'Русский' }
            ];

            useEffect(() => {
                if (screen === 'chat') {
                    loadMessages();
                    pollIntervalRef.current = setInterval(loadMessages, 3000);
                }
                return () => {
                    if (pollIntervalRef.current) {
                        clearInterval(pollIntervalRef.current);
                    }
                };
            }, [screen, currentRoom]);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            const loadMessages = async () => {
                if (!currentRoom) return;
                
                try {
                    const result = await window.storage.get(`room:${currentRoom.id}:messages`);
                    if (result && result.value) {
                        const loadedMessages = JSON.parse(result.value);
                        setMessages(loadedMessages);
                    }
                } catch (error) {
                    console.log('メッセージの読み込み中:', error.message);
                }
            };

            const saveMessages = async (newMessages) => {
                try {
                    await window.storage.set(
                        `room:${currentRoom.id}:messages`,
                        JSON.stringify(newMessages)
                    );
                } catch (error) {
                    setError('メッセージの保存に失敗しました');
                }
            };

            const translateText = async (text, targetLang) => {
                try {
                    const response = await fetch(
                        `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`
                    );
                    const data = await response.json();
                    return data[0][0][0];
                } catch (error) {
                    console.error('Translation error:', error);
                    return text;
                }
            };

            const handleLogin = async () => {
                if (!roomId || !password || !userName || !userLanguage) {
                    setError('全ての項目を入力してください');
                    return;
                }

                try {
                    const roomKey = `room:${roomId}`;
                    const roomData = await window.storage.get(roomKey);

                    if (roomData) {
                        const room = JSON.parse(roomData.value);
                        if (room.password !== password) {
                            setError('パスワードが正しくありません');
                            return;
                        }
                        
                        if (room.users.length >= 2 && !room.users.find(u => u.name === userName)) {
                            setError('このルームは既に満員です');
                            return;
                        }

                        const existingUser = room.users.find(u => u.name === userName);
                        if (!existingUser) {
                            room.users.push({ name: userName, language: userLanguage });
                            await window.storage.set(roomKey, JSON.stringify(room));
                        }

                        setCurrentRoom({
                            id: roomId,
                            password: password,
                            users: room.users
                        });
                    } else {
                        const newRoom = {
                            password: password,
                            users: [{ name: userName, language: userLanguage }],
                            createdAt: new Date().toISOString()
                        };
                        await window.storage.set(roomKey, JSON.stringify(newRoom));
                        await window.storage.set(`room:${roomId}:messages`, JSON.stringify([]));
                        
                        setCurrentRoom({
                            id: roomId,
                            password: password,
                            users: newRoom.users
                        });
                    }

                    setError('');
                    setScreen('chat');
                } catch (error) {
                    setError('ルームへの接続に失敗しました');
                }
            };

            const handleSendMessage = async () => {
                if (!message.trim() || !currentRoom) return;

                const otherUser = currentRoom.users.find(u => u.name !== userName);
                if (!otherUser) {
                    setError('相手がまだ参加していません');
                    return;
                }

                const translatedText = await translateText(message, otherUser.language);
                
                const newMessage = {
                    id: Date.now(),
                    sender: userName,
                    senderLang: userLanguage,
                    originalText: message,
                    translatedText: translatedText,
                    timestamp: new Date().toISOString()
                };

                const updatedMessages = [...messages, newMessage];
                setMessages(updatedMessages);
                await saveMessages(updatedMessages);
                setMessage('');
            };

            const startRecording = () => {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    setError('お使いのブラウザは音声認識に対応していません');
                    return;
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognitionRef.current = new SpeechRecognition();
                recognitionRef.current.lang = userLanguage;
                recognitionRef.current.continuous = false;
                recognitionRef.current.interimResults = false;

                recognitionRef.current.onstart = () => {
                    setIsRecording(true);
                    setError('');
                };

                recognitionRef.current.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    setMessage(transcript);
                };

                recognitionRef.current.onerror = (event) => {
                    setError('音声認識エラー: ' + event.error);
                    setIsRecording(false);
                };

                recognitionRef.current.onend = () => {
                    setIsRecording(false);
                };

                recognitionRef.current.start();
            };

            const stopRecording = () => {
                if (recognitionRef.current) {
                    recognitionRef.current.stop();
                    setIsRecording(false);
                }
            };

            const handleLogout = () => {
                if (pollIntervalRef.current) {
                    clearInterval(pollIntervalRef.current);
                }
                setScreen('login');
                setCurrentRoom(null);
                setMessages([]);
                setRoomId('');
                setPassword('');
                setError('');
            };

            const clearRoom = async () => {
                if (!window.confirm('このルームの全メッセージを削除しますか?')) return;
                
                try {
                    await window.storage.set(`room:${currentRoom.id}:messages`, JSON.stringify([]));
                    setMessages([]);
                } catch (error) {
                    setError('メッセージの削除に失敗しました');
                }
            };

            if (screen === 'login') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
                            <div className="flex items-center justify-center mb-6">
                                <div className="text-indigo-600 mr-3"><Globe /></div>
                                <h1 className="text-3xl font-bold text-gray-800">翻訳チャット</h1>
                            </div>
                            
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        ルームID
                                    </label>
                                    <input
                                        type="text"
                                        value={roomId}
                                        onChange={(e) => setRoomId(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                        placeholder="room123"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        パスワード
                                    </label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                        placeholder="••••••"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        ユーザー名
                                    </label>
                                    <input
                                        type="text"
                                        value={userName}
                                        onChange={(e) => setUserName(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                        placeholder="太郎"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        あなたの言語
                                    </label>
                                    <select
                                        value={userLanguage}
                                        onChange={(e) => setUserLanguage(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    >
                                        {languages.map(lang => (
                                            <option key={lang.code} value={lang.code}>{lang.name}</option>
                                        ))}
                                    </select>
                                </div>

                                {error && (
                                    <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
                                        {error}
                                    </div>
                                )}

                                <button
                                    onClick={handleLogin}
                                    className="w-full bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700 transition-colors flex items-center justify-center"
                                >
                                    <span className="mr-2"><Lock /></span>
                                    ルームに入る
                                </button>

                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-800">
                                    <p className="font-medium mb-1">💡 使い方</p>
                                    <ul className="list-disc list-inside space-y-1 text-xs">
                                        <li>同じルームIDとパスワードで2人が入室できます</li>
                                        <li>メッセージは自動で相手の言語に翻訳されます</li>
                                        <li>音声入力にも対応しています</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex flex-col h-screen bg-gray-100">
                    <div className="bg-indigo-600 text-white p-4 shadow-lg">
                        <div className="max-w-4xl mx-auto flex items-center justify-between">
                            <div className="flex items-center">
                                <span className="mr-3"><Users /></span>
                                <div>
                                    <h2 className="font-bold text-lg">ルーム: {currentRoom?.id}</h2>
                                    <p className="text-sm text-indigo-200">
                                        {userName} ({languages.find(l => l.code === userLanguage)?.name})
                                    </p>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button
                                    onClick={clearRoom}
                                    className="p-2 hover:bg-indigo-700 rounded-lg transition-colors"
                                    title="メッセージを全削除"
                                >
                                    <Trash2 />
                                </button>
                                <button
                                    onClick={handleLogout}
                                    className="p-2 hover:bg-indigo-700 rounded-lg transition-colors"
                                    title="ログアウト"
                                >
                                    <LogOut />
                                </button>
                            </div>
                        </div>
                    </div>

                    {currentRoom && currentRoom.users.length < 2 && (
                        <div className="bg-yellow-50 border-b border-yellow-200 p-3 text-center text-yellow-800 text-sm">
                            相手の参加を待っています...
                        </div>
                    )}

                    {error && (
                        <div className="bg-red-50 border-b border-red-200 p-3 text-center text-red-700 text-sm">
                            {error}
                        </div>
                    )}

                    <div className="flex-1 overflow-y-auto p-4 max-w-4xl w-full mx-auto">
                        <div className="space-y-4">
                            {messages.map((msg) => {
                                const isOwnMessage = msg.sender === userName;
                                return (
                                    <div
                                        key={msg.id}
                                        className={`flex ${isOwnMessage ? 'justify-end' : 'justify-start'}`}
                                    >
                                        <div
                                            className={`max-w-xs lg:max-w-md xl:max-w-lg rounded-2xl p-4 ${
                                                isOwnMessage
                                                    ? 'bg-indigo-600 text-white'
                                                    : 'bg-white text-gray-800 shadow-md'
                                            }`}
                                        >
                                            <div className="font-medium text-sm mb-1">
                                                {msg.sender}
                                            </div>
                                            <div className="break-words">
                                                {isOwnMessage ? msg.originalText : msg.translatedText}
                                            </div>
                                            {!isOwnMessage && (
                                                <div className="text-xs mt-2 pt-2 border-t border-gray-200 text-gray-500">
                                                    原文: {msg.originalText}
                                                </div>
                                            )}
                                            <div className={`text-xs mt-2 ${isOwnMessage ? 'text-indigo-200' : 'text-gray-400'}`}>
                                                {new Date(msg.timestamp).toLocaleTimeString('ja-JP', {
                                                    hour: '2-digit',
                                                    minute: '2-digit'
                                                })}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                            <div ref={messagesEndRef} />
                        </div>
                    </div>

                    <div className="bg-white border-t border-gray-200 p-4">
                        <div className="max-w-4xl mx-auto flex gap-2">
                            <button
                                onClick={isRecording ? stopRecording : startRecording}
                                className={`p-3 rounded-lg transition-colors ${
                                    isRecording
                                        ? 'bg-red-600 text-white hover:bg-red-700'
                                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                }`}
                                title={isRecording ? '録音停止' : '音声入力'}
                            >
                                {isRecording ? <MicOff /> : <Mic />}
                            </button>
                            
                            <input
                                type="text"
                                value={message}
                                onChange={(e) => setMessage(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                                placeholder="メッセージを入力..."
                                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            />
                            
                            <button
                                onClick={handleSendMessage}
                                disabled={!message.trim()}
                                className="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                                title="送信"
                            >
                                <Send />
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<TranslationChatApp />, document.getElementById('root'));
    </script>
</body>
</html>
