<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¿»è¨³ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div id="app">
        <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md text-center">
                <div class="text-6xl mb-4">â³</div>
                <p class="text-lg font-medium text-gray-700">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>
    </div>
    
    <!-- è¨­å®šã‚’æœ€åˆã«èª­ã¿è¾¼ã‚€ -->
    <script src="./js/config.js"></script>
    
    <!-- Firebase Serviceã‚’ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã§èª­ã¿è¾¼ã‚€ -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, get, set, update, remove, onValue, off, serverTimestamp, push } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        // ğŸ”¥ Firebase Authentication ã‚’è¿½åŠ 
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(CONFIG.firebase);
        const database = getDatabase(app);
        const auth = getAuth(app); // ğŸ”¥ èªè¨¼åˆæœŸåŒ–

        class FirebaseService {
            constructor() {
                this.app = app;
                this.database = database;
                this.initialized = true;
            }

            ref(path) {
                return ref(this.database, path);
            }

            async get(path) {
                const snapshot = await get(this.ref(path));
                return snapshot.val();
            }

            async set(path, data) {
                await set(this.ref(path), data);
            }

            async update(path, data) {
                await update(this.ref(path), data);
            }

            async remove(path) {
                await remove(this.ref(path));
            }

            onValue(path, callback) {
                return onValue(this.ref(path), callback);
            }

            off(path, callback) {
                off(this.ref(path), callback);
            }

            getServerTimestamp() {
                return serverTimestamp();
            }

            push(path) {
                return push(this.ref(path));
            }
        }

        window.firebaseService = new FirebaseService();
        console.log('âœ… Firebase Service ã‚»ãƒƒãƒˆå®Œäº†');

        // ğŸ”¥ Firebase Authentication Service
        class AdminAuthService {
            constructor() {
                this.auth = auth;
                this.currentUser = null;
                
                // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
                onAuthStateChanged(this.auth, (user) => {
                    this.currentUser = user;
                    console.log('èªè¨¼çŠ¶æ…‹:', user ? 'âœ… ãƒ­ã‚°ã‚¤ãƒ³ä¸­' : 'âŒ æœªãƒ­ã‚°ã‚¤ãƒ³');
                });
            }

            // ãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³
            async login(email, password) {
                try {
                    const userCredential = await signInWithEmailAndPassword(this.auth, email, password);
                    console.log('âœ… Firebaseèªè¨¼æˆåŠŸ');
                    return { success: true, user: userCredential.user };
                } catch (error) {
                    console.error('âŒ Firebaseèªè¨¼å¤±æ•—:', error.code);
                    
                    let errorMessage = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ';
                    if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                        errorMessage = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
                    } else if (error.code === 'auth/too-many-requests') {
                        errorMessage = 'è©¦è¡Œå›æ•°ãŒå¤šã™ãã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
                    }
                    
                    return { success: false, error: errorMessage };
                }
            }

            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            async logout() {
                try {
                    await signOut(this.auth);
                    console.log('âœ… ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæˆåŠŸ');
                    return { success: true };
                } catch (error) {
                    console.error('âŒ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¤±æ•—:', error);
                    return { success: false };
                }
            }

            // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç¢ºèª
            isLoggedIn() {
                return this.currentUser !== null;
            }

            // æ‹›å¾…ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
            generateInviteToken(roomId, password) {
                const data = `${roomId}:${password}:${Date.now()}`;
                return btoa(data);
            }

            // æ‹›å¾…ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
            validateInviteToken(token) {
                try {
                    const decoded = atob(token);
                    const parts = decoded.split(':');
                    if (parts.length === 3) {
                        return {
                            valid: true,
                            roomId: parts[0],
                            password: parts[1],
                            timestamp: parseInt(parts[2])
                        };
                    }
                } catch (e) {
                    console.error('ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã‚¨ãƒ©ãƒ¼:', e);
                }
                return { valid: false };
            }
        }

        window.adminAuthService = new AdminAuthService();
        console.log('âœ… Admin Auth Service åˆæœŸåŒ–å®Œäº†');
    </script>
    
    <!-- LibreTranslateç¿»è¨³ã‚µãƒ¼ãƒ“ã‚¹ã‚’èª­ã¿è¾¼ã‚€ -->
    <script src="./js/translation-service.js"></script>
    
    <!-- ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’èª­ã¿è¾¼ã‚€ -->
    <script src="./js/auth-service.js"></script>
    <script src="./js/chat-service.js"></script>
    
    <!-- æœ€å¾Œã«ã‚¢ãƒ—ãƒªã‚’èª­ã¿è¾¼ã‚€ -->
    <script>
        // å…¨ã‚µãƒ¼ãƒ“ã‚¹ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
        window.addEventListener('load', () => {
            console.log('Services check:', {
                firebase: !!window.firebaseService,
                translation: !!window.translationService,
                auth: !!window.authService,
                chat: !!window.chatService,
                adminAuth: !!window.adminAuthService // ğŸ”¥ è¿½åŠ 
            });
            
            // Firebase Serviceæº–å‚™å®Œäº†ã‚’é€šçŸ¥
            window.firebaseServiceReady = true;
            window.dispatchEvent(new Event('firebaseServiceReady'));
        });
    </script>
    <script src="./js/app.js"></script>
</body>
</html>
